// main.js - Instrucciones para nuestro robot
const Actor = require('apify');
const log = Actor.log;  // Para escribir mensajes que podamos ver

Actor.main(async () => {
    log.info('ü§ñ ¬°Hola! Soy el robot de art√≠culos, comenzando mi trabajo...');

    // 1. Recibir la direcci√≥n web de la lista de art√≠culos
    const input = await Apify.getInput();
    const paginaDeListaDeArticulos = input.startUrl; // Esperamos que nos den una "startUrl"

    if (!paginaDeListaDeArticulos) {
        log.error('üÜò ¬°Oh no! No me diste una "startUrl" para empezar. No puedo trabajar as√≠.');
        return; // Terminar el trabajo
    }
    log.info(`üó∫Ô∏è Voy a empezar mirando esta p√°gina: ${paginaDeListaDeArticulos}`);

    // 2. Preparar una "lista de tareas pendientes" para las p√°ginas a visitar
    const colaDePaginas = await Apify.openRequestQueue();
    await colaDePaginas.addRequest({
        url: paginaDeListaDeArticulos,
        userData: { tipoDePagina: 'LISTA_DE_ARTICULOS' }, // Una etiqueta para saber qu√© hacer
    });

    // 3. Crear el "navegador robot" que visitar√° las p√°ginas
    const navegadorRobot = new Apify.PuppeteerCrawler({
        requestQueue: colaDePaginas, // Usar√° nuestra lista de tareas
        launchContext: {
            args: ['--no-sandbox', '--disable-setuid-sandbox'], // Configuraciones t√©cnicas para Apify
        },
        minConcurrency: 1, // Visitar 1 p√°gina a la vez (para empezar)
        maxConcurrency: 1, // Visitar 1 p√°gina a la vez (para empezar)
        maxRequestRetries: 1, // Si una p√°gina falla, intentarlo 1 vez m√°s
        handlePageTimeoutSecs: 180, // Tiempo m√°ximo para procesar una p√°gina (3 minutos)

        // 4. QU√â HACER EN CADA P√ÅGINA QUE VISITE EL NAVEGADOR ROBOT
        handlePageFunction: async ({ request, page }) => {
            const urlActual = request.url;
            const tipoDePagina = request.userData.tipoDePagina;

            log.info(`üìÑ Estoy en [${tipoDePagina}]: ${urlActual}`);

            if (tipoDePagina === 'LISTA_DE_ARTICULOS') {
                // --- ESTAMOS EN LA P√ÅGINA QUE TIENE LA LISTA DE ART√çCULOS ---
                log.info('   üßê Es una lista. Voy a buscar los enlaces a cada art√≠culo...');

                // ***** ¬°¬°¬°NECESITAS CAMBIAR ESTO PARA TU SITIO WEB ESPEC√çFICO (ej. shape.com)!!! *****
                // Instrucci√≥n para encontrar los enlaces. Esto es un EJEMPLO GEN√âRICO.
                const SELECTOR_DE_ENLACES_A_ARTICULOS = 'a.card__title-link'; // EJEMPLO PARA INTENTAR CON SHAPE.COM

                log.info(`      Usando selector para enlaces de lista: "${SELECTOR_DE_ENLACES_A_ARTICULOS}"`);

                // El robot le pide al navegador que busque usando el selector
                const urlsDeArticulos = await page.evaluate((selector) => {
                    const enlacesEncontrados = [];
                    document.querySelectorAll(selector).forEach(elementoAncla => {
                        if (elementoAncla.href && !elementoAncla.href.startsWith('javascript:')) { // Ignorar enlaces javascript
                            enlacesEncontrados.push(elementoAncla.href);
                        }
                    });
                    return enlacesEncontrados;
                }, SELECTOR_DE_ENLACES_A_ARTICULOS);

                log.info(`   üîç Encontr√© ${urlsDeArticulos.length} enlaces a art√≠culos.`);
                if (urlsDeArticulos.length > 0) {
                    log.info(`      Algunos ejemplos (max 3): ${urlsDeArticulos.slice(0, 3).join(' | ')}`);
                } else {
                    log.warning('      ‚ö†Ô∏è ¬°No encontr√© ning√∫n enlace con ese selector! Revisa el SELECTOR_DE_ENLACES_A_ARTICULOS.');
                    // Guardar el HTML de esta p√°gina para ver por qu√© no encontr√≥ nada
                    const htmlDePaginaLista = await page.content();
                    await Apify.setValue('DEBUG_PAGINA_LISTA_HTML', htmlDePaginaLista, { contentType: 'text/html' });
                    log.info('      (Guard√© el HTML de esta p√°gina de lista como "DEBUG_PAGINA_LISTA_HTML" para que lo revises en el Key-Value Store de Apify)');
                }

                // A√±adir cada enlace de art√≠culo a nuestra lista de tareas pendientes
                for (const urlArticulo of urlsDeArticulos) {
                    try {
                        const urlAbsolutaArticulo = new URL(urlArticulo, urlActual).href; // Convierte a URL absoluta
                        log.info(`      ‚ûï A√±adiendo a la cola para visitar (art√≠culo individual): ${urlAbsolutaArticulo}`);
                        await colaDePaginas.addRequest({
                            url: urlAbsolutaArticulo,
                            userData: { tipoDePagina: 'PAGINA_DE_ARTICULO' }, // Nueva etiqueta
                        });
                    } catch (e) {
                        log.error(`      ‚ùå Error al procesar o crear URL absoluta para "${urlArticulo}" (base: ${urlActual}): ${e.message}`);
                    }
                }

            } else if (tipoDePagina === 'PAGINA_DE_ARTICULO') {
                // --- ESTAMOS EN LA P√ÅGINA DE UN ART√çCULO INDIVIDUAL ---
                log.info('   ‚úçÔ∏è Es la p√°gina de un art√≠culo. Voy a extraer la informaci√≥n...');

                // ***** ¬°¬°¬°NECESITAS CAMBIAR ESTOS PARA TU SITIO WEB ESPEC√çFICO (ej. shape.com)!!! *****
                // Instrucciones para encontrar el t√≠tulo, contenido, etc. EJEMPLOS GEN√âRICOS.
                const SELECTOR_TITULO = 'h1#article-heading_1-0';     // EJEMPLO PARA INTENTAR CON SHAPE.COM
                const SELECTOR_CONTENIDO = 'div#article-body_1-0';   // EJEMPLO PARA INTENTAR CON SHAPE.COM
                // const SELECTOR_FECHA = 'span.tu-clase-de-fecha';    // Opcional
                // const SELECTOR_AUTOR = 'a.tu-clase-de-autor';      // Opcional

                log.info(`      Usando selector de t√≠tulo: "${SELECTOR_TITULO}"`);
                log.info(`      Usando selector de contenido: "${SELECTOR_CONTENIDO}"`);

                // El robot le pide al navegador que busque esta informaci√≥n
                const datosExtraidos = await page.evaluate((selTitulo, selContenido /*, selFecha, selAutor*/) => {
                    const titulo = document.querySelector(selTitulo)?.innerText.trim();

                    let textoContenido = '';
                    const elementoContenido = document.querySelector(selContenido);
                    if (elementoContenido) {
                        // Intentar tomar solo el texto de p√°rrafos y encabezados dentro del contenido
                        elementoContenido.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li').forEach(el => {
                            textoContenido += el.innerText.trim() + '\n\n'; // Doble salto de l√≠nea entre p√°rrafos
                        });
                        if (!textoContenido && elementoContenido.innerText) { // Si no encontr√≥ p√°rrafos, etc., tomar todo el texto del contenedor
                            textoContenido = elementoContenido.innerText.trim();
                        }
                    }

                    // const fecha = document.querySelector(selFecha)?.innerText.trim();
                    // const autor = document.querySelector(selAutor)?.innerText.trim();

                    return {
                        titulo: titulo,
                        contenido: textoContenido,
                        // fechaPublicacion: fecha,
                        // autor: autor
                    };
                }, SELECTOR_TITULO, SELECTOR_CONTENIDO /*, SELECTOR_FECHA, SELECTOR_AUTOR*/);

                log.info(`      T√≠tulo encontrado: ${datosExtraidos.titulo}`);
                log.info(`      Contenido encontrado (primeros 100 caracteres): ${datosExtraidos.contenido?.substring(0, 100)}...`);

                // Guardar la informaci√≥n encontrada si tenemos al menos t√≠tulo o contenido
                if (datosExtraidos.titulo || datosExtraidos.contenido) {
                    await Apify.pushData({
                        urlDelArticulo: urlActual,
                        tituloDelArticulo: datosExtraidos.titulo,
                        textoDelArticulo: datosExtraidos.contenido?.trim(), // Quitar espacios extra al final del contenido completo
                        // fecha: datosExtraidos.fechaPublicacion,
                        // autor: datosExtraidos.autor,
                    });
                    log.info(`   üíæ ¬°Informaci√≥n guardada para: ${datosExtraidos.titulo || urlActual}!`);
                } else {
                    log.warning(`      ‚ö†Ô∏è No pude extraer t√≠tulo o contenido de esta p√°gina de art√≠culo: ${urlActual}`);
                     // Guardar el HTML de esta p√°gina para ver por qu√© no encontr√≥ nada
                    const htmlDePaginaDetalle = await page.content();
                    // Crear una clave √∫nica para el archivo HTML de debug reemplazando caracteres no v√°lidos
                    const debugKey = `DEBUG_PAGINA_DETALLE_HTML_${request.uniqueKey.replace(/[\/:\.]/g, '_')}`;
                    await Apify.setValue(debugKey, htmlDePaginaDetalle, { contentType: 'text/html' });
                    log.info(`      (Guard√© el HTML de esta p√°gina de detalle como "${debugKey}" para que lo revises en el Key-Value Store de Apify)`);
                }
            }
        },

        // Qu√© hacer si una p√°gina da un error al cargarla
        handleFailedRequestFunction: async ({ request, error }) => {
            log.error(`‚ùå ¬°Ups! Fall√≥ la visita a ${request.url} (Etiqueta: ${request.userData.tipoDePagina}): ${error.message}`);
        },
    });

    // 5. PONER AL NAVEGADOR ROBOT A TRABAJAR
    log.info('‚ñ∂Ô∏è  El navegador robot va a empezar a visitar las p√°ginas...');
    await navegadorRobot.run();
    log.info('üèÅ ¬°Trabajo terminado por el navegador robot!');
});
